# =============================================================================
# GitHub Actions - CI/CD Pipeline for Laravel Docker Application
# Triggered on push to main branch
#
# Required GitHub Secrets:
#   - SSH_PRIVATE_KEY: SSH private key for Azure VM access
#   - SSH_KNOWN_HOSTS: SSH host verification string
#   - SERVER_HOST: Azure VM IP address or hostname
#   - SERVER_USER: SSH username for deployment
#   - COMPOSER_AUTH: Composer authentication JSON for private packages (e.g., FluxUI Pro)
#   - SLACK_WEBHOOK_URL: (Optional) Slack notification webhook
# =============================================================================

name: Deploy Laravel Application

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PHP_VERSION: '8.3'
  NODE_VERSION: '22'

# Ensure only one deployment runs at a time
concurrency:
  group: production
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # TEST JOB - Run PHP and JavaScript tests
  # ===========================================================================
  test:
    name: Test Application
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: laravel_test
          POSTGRES_USER: laravel
          POSTGRES_PASSWORD: secret
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_pgsql, redis, bcmath, gd, intl, zip, mbstring, xml
          coverage: xdebug
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/package-lock.json

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
        working-directory: src

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('src/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader
        working-directory: src

      - name: Install NPM dependencies
        run: npm ci
        working-directory: src

      - name: Build frontend assets
        run: npm run build
        working-directory: src

      - name: Copy environment file
        run: cp .env.example .env
        working-directory: src

      - name: Generate application key
        run: php artisan key:generate
        working-directory: src

      - name: Run database migrations
        run: php artisan migrate --force
        working-directory: src
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: laravel_test
          DB_USERNAME: laravel
          DB_PASSWORD: secret

      - name: Run PHPUnit tests
        run: php artisan test --parallel --coverage-clover coverage.xml
        working-directory: src
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: laravel_test
          DB_USERNAME: laravel
          DB_PASSWORD: secret
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          CACHE_DRIVER: redis
          SESSION_DRIVER: redis
          QUEUE_CONNECTION: redis

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: src/coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # ===========================================================================
  # BUILD JOB - Build and push Docker images
  # ===========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      image-digest: ${{ steps.build-php.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Build PHP-FPM Image
      # -----------------------------------------------------------------------
      - name: Extract metadata for PHP-FPM image
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php-fpm
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push PHP-FPM image
        id: build-php
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/common/php-fpm/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          secrets: |
            composer_auth=${{ secrets.COMPOSER_AUTH }}

      # -----------------------------------------------------------------------
      # Build Nginx Image
      # -----------------------------------------------------------------------
      - name: Extract metadata for Nginx image
        id: nginx-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Nginx image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/production/nginx/Dockerfile
          push: true
          tags: ${{ steps.nginx-meta.outputs.tags }}
          labels: ${{ steps.nginx-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ===========================================================================
  # DEPLOY JOB - Deploy to Azure VM
  # ===========================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
        run: |
          ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e

            echo "=== Starting deployment ==="
            cd /opt/laravel

            # Pull latest images
            echo "Pulling latest Docker images..."
            docker compose -f docker-compose.prod.yml pull

            # Run database migrations (in a temporary container)
            echo "Running database migrations..."
            docker compose -f docker-compose.prod.yml run --rm \
              -e MIGRATE_ON_START=false \
              php-fpm php artisan migrate --force

            # Deploy with zero-downtime (rolling update)
            echo "Starting containers..."
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

            # Wait for health checks
            echo "Waiting for services to be healthy..."
            sleep 15

            # Clear and rebuild caches
            echo "Optimizing Laravel..."
            docker compose -f docker-compose.prod.yml exec -T php-fpm php artisan optimize:clear
            docker compose -f docker-compose.prod.yml exec -T php-fpm php artisan config:cache
            docker compose -f docker-compose.prod.yml exec -T php-fpm php artisan route:cache
            docker compose -f docker-compose.prod.yml exec -T php-fpm php artisan view:cache
            docker compose -f docker-compose.prod.yml exec -T php-fpm php artisan event:cache || true

            # Restart queue workers to pick up new code
            echo "Restarting queue workers..."
            docker compose -f docker-compose.prod.yml restart queue

            # Verify health
            echo "Running health check..."
            sleep 5
            curl -sf http://localhost/health || { echo "Health check failed!"; exit 1; }

            # Clean up old Docker images
            echo "Cleaning up old images..."
            docker image prune -af --filter "until=168h" || true

            echo "=== Deployment completed successfully ==="
          ENDSSH

      - name: Notify success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Deployment successful for ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Successful* :white_check_mark:\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Deployment FAILED for ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Failed* :x:\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
