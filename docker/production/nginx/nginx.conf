# =============================================================================
# Nginx Configuration - Production Environment (Security Hardened)
# SSL termination handled by Cloudflare
# =============================================================================

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log error;
pid /var/run/nginx.pid;

# Security: Limit worker file descriptors
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    multi_accept on;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ==========================================================================
    # SECURITY HARDENING
    # ==========================================================================

    # Hide Nginx version in responses
    server_tokens off;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # XSS Protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer Policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions Policy (disable unused browser features)
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;

    # ==========================================================================
    # LOGGING
    # ==========================================================================

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    log_format security '$remote_addr - [$time_local] "$request" '
                        '$status "$http_referer" "$http_user_agent" '
                        'cf_ip="$http_cf_connecting_ip" country="$http_cf_ipcountry"';

    access_log /var/log/nginx/access.log main buffer=16k flush=2m;

    # ==========================================================================
    # PERFORMANCE
    # ==========================================================================

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 30;
    types_hash_max_size 2048;

    # ==========================================================================
    # REQUEST LIMITS (Security)
    # ==========================================================================

    # Limit request body size
    client_max_body_size 32m;
    client_body_buffer_size 16k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;

    # Request timeouts
    client_body_timeout 30s;
    client_header_timeout 30s;
    send_timeout 30s;

    # ==========================================================================
    # RATE LIMITING
    # ==========================================================================

    # Rate limit zone for API requests (10 requests/second per IP)
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    # Connection limit zone (max connections per IP)
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # Rate limit zone for login attempts (more restrictive)
    limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;

    # ==========================================================================
    # GZIP COMPRESSION
    # ==========================================================================

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml
        application/xml+rss
        application/x-font-ttf
        application/vnd.ms-fontobject
        font/opentype
        font/woff
        font/woff2
        image/svg+xml
        image/x-icon;

    # ==========================================================================
    # UPSTREAM (PHP-FPM)
    # ==========================================================================

    upstream php-fpm {
        server php-fpm:9000;
        keepalive 32;
    }

    # ==========================================================================
    # SERVER BLOCK
    # ==========================================================================

    server {
        listen 80;
        server_name _;
        root /var/www/public;
        index index.php;

        charset utf-8;

        # ======================================================================
        # CLOUDFLARE INTEGRATION
        # ======================================================================

        # Restore real visitor IP from Cloudflare
        # IPv4 ranges
        set_real_ip_from 173.245.48.0/20;
        set_real_ip_from 103.21.244.0/22;
        set_real_ip_from 103.22.200.0/22;
        set_real_ip_from 103.31.4.0/22;
        set_real_ip_from 141.101.64.0/18;
        set_real_ip_from 108.162.192.0/18;
        set_real_ip_from 190.93.240.0/20;
        set_real_ip_from 188.114.96.0/20;
        set_real_ip_from 197.234.240.0/22;
        set_real_ip_from 198.41.128.0/17;
        set_real_ip_from 162.158.0.0/15;
        set_real_ip_from 104.16.0.0/13;
        set_real_ip_from 104.24.0.0/14;
        set_real_ip_from 172.64.0.0/13;
        set_real_ip_from 131.0.72.0/22;

        # IPv6 ranges
        set_real_ip_from 2400:cb00::/32;
        set_real_ip_from 2606:4700::/32;
        set_real_ip_from 2803:f800::/32;
        set_real_ip_from 2405:b500::/32;
        set_real_ip_from 2405:8100::/32;
        set_real_ip_from 2a06:98c0::/29;
        set_real_ip_from 2c0f:f248::/32;

        real_ip_header CF-Connecting-IP;

        # ======================================================================
        # CONTENT SECURITY POLICY
        # ======================================================================

        # CSP header - adjust based on your application's requirements
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

        # ======================================================================
        # HEALTH CHECK (No rate limiting, no logging)
        # ======================================================================

        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # ======================================================================
        # STATIC FILES (Aggressive caching)
        # ======================================================================

        location ~* \.(jpg|jpeg|png|gif|ico|webp|avif)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff" always;
            access_log off;
            try_files $uri =404;
        }

        location ~* \.(css|js|woff|woff2|ttf|eot|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff" always;
            access_log off;
            try_files $uri =404;
        }

        # ======================================================================
        # LARAVEL ROUTING
        # ======================================================================

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        # Disable logging for common files
        location = /favicon.ico { access_log off; log_not_found off; }
        location = /robots.txt  { access_log off; log_not_found off; }

        # Error handling via Laravel
        error_page 404 /index.php;

        # ======================================================================
        # PHP HANDLING (with rate limiting)
        # ======================================================================

        location ~ \.php$ {
            # Apply rate limiting
            limit_req zone=api burst=20 nodelay;
            limit_conn conn_limit 10;

            # FastCGI configuration
            fastcgi_pass php-fpm;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include fastcgi_params;

            # Security: Hide PHP version
            fastcgi_hide_header X-Powered-By;

            # Production timeouts
            fastcgi_connect_timeout 60;
            fastcgi_send_timeout 60;
            fastcgi_read_timeout 60;

            # Buffer settings
            fastcgi_buffer_size 128k;
            fastcgi_buffers 256 16k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;

            # Keepalive connections to PHP-FPM
            fastcgi_keep_conn on;
        }

        # ======================================================================
        # LOGIN ENDPOINT (Stricter rate limiting)
        # ======================================================================

        location ~ ^/(login|register|password) {
            limit_req zone=login burst=5 nodelay;
            limit_conn conn_limit 5;

            try_files $uri $uri/ /index.php?$query_string;
        }

        # ======================================================================
        # SECURITY: BLOCK SENSITIVE FILES AND DIRECTORIES
        # ======================================================================

        # Block hidden files (except .well-known for SSL verification)
        location ~ /\.(?!well-known).* {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to sensitive files
        location ~ /\.(env|git|gitignore|htaccess|htpasswd|dockerignore) {
            deny all;
            access_log /var/log/nginx/security.log security;
        }

        # Block access to composer files
        location ~ /(composer\.(json|lock)|package\.(json|lock)) {
            deny all;
        }

        # Block access to Laravel directories that shouldn't be public
        location ~ ^/(storage|bootstrap|vendor|node_modules)/ {
            deny all;
            access_log /var/log/nginx/security.log security;
        }

        # Block PHP files in upload directories (prevent RCE)
        location ~* /(?:uploads|files|images)/.*\.php$ {
            deny all;
        }

        # Block access to backup files
        location ~* \.(sql|bak|backup|old|orig|save)$ {
            deny all;
        }
    }
}
